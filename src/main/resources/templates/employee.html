<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>Employee page</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">



        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    </head>
    <body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="#"> Employee Management System</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item active">
                    <a class="nav-link" href="employee">Employees <span class="sr-only">(current)</span></a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="department2">Departments</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="position">Poisitions</a>
                </li>

            </ul>
        </div>
    </nav>
        <div class="container">
            <button id="addEmpBtn" class="btn pull-right" style="margin-bottom:10px;" onClick="location.href = 'employee_add'" >Add Employee</button>
        </div>

        <div class="table-responsive" style="margin: 10px">
            <table class="table table-bordered" id="employeesTable">
                <thead>
                    <tr>
                        <th>Id</th>
                        <th>Name</th>
                        <th>Surname</th>
                        <th>Birth date</th>
                        <th>phone</th>
                        <th>email</th>
                        <th>Position</th>
                        <th>Employment date</th>
                        <th>Department</th>
                        <th>Parent Employee</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>

                </tbody>
            </table>
        </div> 

        <div class="modal fade in" id="modalDialogPosition" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title">Edit Employee data</h4>
                    </div>
                    <form class="form-horizontal" style="padding:  10px">
                        <div class="form-group">
                            <label for="nameInput" class="col-sm-3 control-label">Name</label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" id="nameInput" placeholder="Name">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="surnameInput" class="col-sm-3 control-label">Surname</label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" id="surnameInput" placeholder="Surname">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="bDayPicker" class="col-sm-3 control-label">Birthday</label>
                            <div class="col-sm-9">
                                <input type="date" name="bday" id="bDayPicker" class="form-control">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="phoneInput" class="col-sm-3 control-label">Phone</label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" id="phoneInput" placeholder="Phone">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="emailInput" class="col-sm-3 control-label">Email</label>
                            <div class="col-sm-9">
                                <input type="email" class="form-control" id="emailInput" placeholder="Email">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="posDropDown" class="col-sm-3 control-label">Position</label>
                            <div class="col-sm-9">
                                <select class="form-control" id="posDropDown">
                                    <option value="">-Select Position-</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="parEmpDropDown" class="col-sm-3 control-label">Employment Date</label>
                            <div class="col-sm-9">
                                <input type="date" name="empDate" id="empDatePicker" class="form-control">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="depsDropDown" class="col-sm-3 control-label">Department</label>
                            <div class="col-sm-9">
                                <select class="form-control" id="depsDropDown">
                                    <option value="">-Select Department-</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="parEmpDropDown" class="col-sm-3 control-label">Parent Employer</label>
                            <div class="col-sm-9">
                                <select class="form-control" id="parEmpDropDown">
                                    <option value="">-Select Parent Employer-</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="col-sm-offset-2 col-sm-10">
                                <button class="btn pull-right" id="saveEmpBtn" data-id="-1">Save</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

        <script>
                $(document).ready(function () {
                    $.ajax({
                        type: "GET",
                        url: "webresources/employee",
                        dataType: "json",
                        success: function (data, textStatus, jqXHR) {
                            if (data.length) {
                                for (var i = 0; i < data.length; i++) {


                                    $('#employeesTable >tbody').append('<tr>' +
                                            '<td>' + data[i].id + '</td>' +
                                            '<td>' + data[i].name + '</td>' +
                                            '<td>' + data[i].surname + '</td>' +
                                            '<td>' + formatDate(data[i].birthDate) + '</td>' +
                                            '<td>' + data[i].phone + '</td>' +
                                            '<td>' + data[i].email + '</td>' +
                                            '<td>' + data[i].departmentId.name + '</td>' +
                                            '<td>' + formatDate(data[i].employmentDate) + '</td>' +
                                            '<td>' + data[i].positionId.name + '</td>' +
                                            '<td>' + (data[i].parentEmployeeId ? data[i].parentEmployeeId.name + " " + data[i].parentEmployeeId.surname : '') + '</td>' +
                                            '<td style="text-align: center;">' +
                                            '<button class="btn btn-info btn-xs empEditBtn">Edit</button>' +
                                            '<button class="btn btn-danger btn-xs empRemoveBtn" style="margin-left:5px;">Remove</button>' +
                                            '</td>' +
                                            '</tr>');
                                }
                            }
                        },
                        error: function (xhr, status, error) {

                        },
                        complete: function () {
                        }
                    });
                });
                function formatDate(date) {
                    var d = new Date(date),
                            month = '' + (d.getMonth() + 1),
                            day = '' + d.getDate(),
                            year = d.getFullYear();

                    if (month.length < 2)
                        month = '0' + month;
                    if (day.length < 2)
                        day = '0' + day;

                    return [day, month, year].join('/');
                }
                // load items to dropDown for Departments
                $(document).ready(function () {

                    $.ajax({
                        type: "GET",
                        url: "webresources/department",
                        dataType: "json",
                        success: function (data, textStatus, jqXHR) {
                            if (data.length) {

                                for (var i = 0; i < data.length; i++) {
                                    $('#depsDropDown').append('<option value="' + data[i].id + '">' + data[i].name + '</option>');
                                }
                            } else {

                            }
                        },
                        error: function (xhr, status, error) {

                        },
                        complete: function () {
                        }
                    });
                });
                // load items to dropDown for Position
                $(document).ready(function () {

                    $.ajax({
                        type: "GET",
                        url: "webresources/position",
                        dataType: "json",
                        success: function (data, textStatus, jqXHR) {
                            if (data.length) {

                                for (var i = 0; i < data.length; i++) {
                                    $('#posDropDown').append('<option value="' + data[i].id + '">' + data[i].name + '</option>');
                                }
                            } else {

                            }
                        },
                        error: function (xhr, status, error) {

                        },
                        complete: function () {
                        }
                    });
                });
                // load items to dropDown for parent Employee
                $(document).ready(function () {
                    $.ajax({
                        type: "GET",
                        url: "webresources/employee",
                        dataType: "json",
                        success: function (data, textStatus, jqXHR) {
                            if (data.length) {

                                for (var i = 0; i < data.length; i++) {
                                    $('#parEmpDropDown').append('<option value="' + data[i].id + '">' + data[i].name + " " + data[i].surname + '</option>');
                                }

                            }
                        },
                        error: function (xhr, status, error) {

                        },
                        complete: function () {
                        }
                    });
                    document.getElementById('empDatePicker').valueAsDate = new Date();

                });


                $(document).on('click', '.empRemoveBtn', function () {
                    var selectedTr = $(this).closest('tr');
                    var empId = selectedTr.find('td:eq(0)').text();

                    $.ajax({
                        type: "DELETE",
                        url: "webresources/employee/" + empId,
                        success: function (data, textStatus, jqXHR) {
                            selectedTr.remove();
                        },
                        error: function (xhr, status, error) {
                            alert(xhr);
                        },
                        complete: function () {
                        }
                    });

                });
                $(document).on('click', '.empEditBtn', function () {
                    var selectedTr = $(this).closest('tr');
                    var empId = selectedTr.find('td:eq(0)').text();

                    $('#saveEmpBtn').attr('data-id', empId);

                    if (empId > 0) {
                        $.ajax({
                            type: "GET",
                            url: "webresources/employee/" + empId,
                            dataType: "json",
                            success: function (data, textStatus, jqXHR) {

                                if (data.length != 0) {
                                    $('#nameInput').val(data.name);
                                    $('#surnameInput').val(data.surname);
                                    $('#phoneInput').val(data.phone);
                                    $('#emailInput').val(data.email);

                                    $('#depsDropDown').val(data.departmentId.id);
                                    $('#posDropDown').val(data.positionId.id);
                                    if (data.parentEmployeeId != null) {
                                        $('#parEmpDropDown').val(data.parentEmployeeId.id);
                                    } else {
                                        $('#parEmpDropDown').val('');
                                    }

                                    var b = data.birthDate;
                                    var bDay = new Date(b.substring(0, b.indexOf('T')));
                                    document.getElementById('bDayPicker').valueAsDate = bDay;

                                    var empDate = data.employmentDate;
                                    var eDay = new Date(empDate.substring(0, b.indexOf('T')));
                                    document.getElementById('empDatePicker').valueAsDate = eDay;
                                }
                            },
                            error: function (xhr, status, error) {

                            },
                            complete: function () {
                            }
                        });
                    }
                    $('#modalDialogPosition').modal('show');
                });
                $(document).on('click', '#saveEmpBtn', function () {
                    var empId = $(this).attr('data-id');
                    var name = $.trim($('#nameInput').val());
                    var surname = $.trim($('#surnameInput').val());
                    var bday = $.trim($('#bDayPicker').val());
                    var phone = $.trim($('#phoneInput').val());
                    var email = $.trim($('#emailInput').val());

                    var posId = $('#posDropDown').val();
                    var depId = $('#depsDropDown').val();
                    var empDate = $.trim($('#empDatePicker').val()) + 'T00:00:00';
                    var parentId = $.trim($('#parEmpDropDown').val());


                    if (name.length == 0) {
                        alert('Enter name!');
                        return false;
                    }
                    if (surname.length == 0) {
                        alert('Enter surname!');
                        return false;
                    }
                    if (bday.length == 0) {
                        alert('Enter birthday!');
                        return false;
                    } else {
                        bday += 'T00:00:00';
                    }
                    if (posId == 0) {
                        alert('enter position!');
                        return false;
                    }
                    if (depId == 0) {
                        alert('enter deparetment!');
                        return false;
                    }
                    var param = null;
                    if (parentId.length > 0) {
                        param = JSON.stringify({
                            id: empId,
                            name: name,
                            surname: surname,
                            birthDate: bday,
                            email: email,
                            phone: phone,
                            employmentDate: empDate,
                            departmentId: {
                                id: depId
                            },
                            positionId: {
                                id: posId
                            },
                            parentEmployeeId: {
                                id: parentId
                            }
                        });
                    } else {
                        param = JSON.stringify({
                            id: empId,
                            name: name,
                            surname: surname,
                            birthDate: bday,
                            email: email,
                            phone: phone,
                            employmentDate: empDate,
                            departmentId: {
                                id: depId
                            },
                            positionId: {
                                id: posId
                            }
                        });
                    }
                    $.ajax({
                        type: "PUT",
                        url: "webresources/employee/" + empId,
                        dataType: "json",
                        contentType: 'application/json',
                        data: param,
                        success: function (data, textStatus, jqXHR) {
                            window.location.reload();
                        },
                        error: function (xhr, status, error) {

                        },
                        complete: function () {
                        }
                    });
                    return false;
                });
        </script>
    </body>
</html>